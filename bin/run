#!/bin/bash

# Ensure an argument is provided
if [[ -z "$1" ]]; then
    echo "Usage: run <filename (without .cpp)> [optional flags]" >&2
    exit 1
fi

filename="$1.cpp"
output="$1"

# Check if the file exists
if [[ ! -f "$filename" ]]; then
    echo "Error: File '$filename' not found!" >&2
    exit 1
fi

todo_lines=$(grep -n "TODO" "$filename" | sed 's/^[0-9]*: *//')
if [[ -n "$todo_lines" ]]; then
    echo "$todo_lines" >&2
    echo -e "\e[31mWarning:\e[0m still found in ${filename}." >&2
    echo "" >&2
fi

extra_flags=""
for arg in "${@:2}"; do
    extra_flags="$extra_flags $arg"
done

# Compile and run
g++ -std=c++20 -O2 -Wall -Wextra -o "$output" "$filename" $extra_flags

# Run only if compilation was successful
if [[ $? -eq 0 ]]; then
    ./"$output"
else
    echo "Compilation failed!" >&2
    exit 1
fi
