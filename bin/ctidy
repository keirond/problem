#!/bin/bash

err_echo() {
	echo "$@" >&2
}

if [[ -z "$1" ]]; then
	err_echo "Usage: ctidy <source_file (without .cpp)> [flags]"
	err_echo ""
	err_echo "Flags:"
	err_echo "  Any additional flags will be passed directly to g++ compilation."
	err_echo "  Example: run program -lcurl -pthread"
	exit 1
fi

source_file="$1.cpp"
shift

if [[ -z "$source_file" ]]; then
	err_echo "Error: No source file provided!"
	exit 1
fi

if [[ ! -f "$source_file" ]]; then
	err_echo "Error: File '$source_file' not found!"
	exit 1
fi

todo_lines=$(grep "TODO" "$source_file" 2>/dev/null)
if [[ -n "$todo_lines" ]]; then
	err_echo -e "\e[38;5;214mWarning:\e[0m TODOs found in '$source_file':"
	err_echo "$todo_lines"
	err_echo ""
fi

err_echo "Checking $source_file syntax with C++20."

flags=("$@")
clang++ -std=c++20 -fsyntax-only -Wall -Wextra -Werror -Wshadow -Wconversion "$source_file" "${flags[@]}"

err_echo "-- Done."
